# See https://cloud.google.com/cloud-build/docs/build-config
# For more information about Image pushing refer to https://github.com/kubernetes/test-infra/blob/master/config/jobs/image-pushing/README.md
timeout: 3600s
options:
  substitution_option: ALLOW_LOOSE
steps:
  - name: 'gcr.io/cloud-builders/bazel'
    env:
      - IMAGE_REGISTRY=gcr.io
      - IMAGE_REPO=k8s-staging-cloud-provider-gcp
      - IMAGE_TAG=${_PULL_BASE_REF}
    args:
      - run
      - //cmd/cloud-controller-manager:publish
  - name: 'gcr.io/cloud-builders/bazel'
    env:
      - IMAGE_REGISTRY=gcr.io
      - IMAGE_REPO=k8s-staging-cloud-provider-gcp
      - IMAGE_TAG=${_PULL_BASE_REF}
    args:
      - run
      - //cmd/gcp-controller-manager:publish
  # build gke-exec-auth-plugin binary
  - name: 'gcr.io/cloud-builders/bazel'
    args:
      - --output_base=/workspace/plugin-binaries
      - build
      - //cmd/gke-exec-auth-plugin
  # build gke-gcloud-auth-plugin binary
  - name: 'gcr.io/cloud-builders/bazel'
    args:
      - --output_base=/workspace/plugin-binaries
      - build
      - //cmd/gke-gcloud-auth-plugin
  # build auth-provider-gcp binary
  - name: 'gcr.io/cloud-builders/bazel'
    args:
      - --output_base=/workspace/plugin-binaries
      - build
      - //cmd/auth-provider-gcp
# upload auth-provider-gcp. gke-gcloud-auth-plugin and gke-exec-auth-plugin binaries
artifacts:
  objects:
    location: 'gs://k8s-staging-cloud-provider-gcp/auth-linux-amd64-$_PULL_BASE_REF'
    paths:
      - '/workspace/plugin-binaries/execroot/io_k8s_cloud_provider_gcp/cmd/auth-provider-gcp'
      - '/workspace/plugin-binaries/execroot/io_k8s_cloud_provider_gcp/cmd/gke-gcloud-auth-plugin'
      - '/workspace/plugin-binaries/execroot/io_k8s_cloud_provider_gcp/cmd/gke-exec-auth-plugin'
substitutions:
  _PULL_BASE_REF: 'master'
